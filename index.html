<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- SEO-TAGS-START -->
    <title>Мой магазин</title>
    <meta name="description" content="Интернет-магазин с широким ассортиментом товаров.">
    <!-- SEO-TAGS-END -->
    <link rel="icon" href="/shop21/icons/icon.png" type="image/png">
    <link rel="manifest" href="/shop21/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#ffffff">
    <meta name="build-version" content="$env:VERCEL_GIT_COMMIT_SHA">
    <link rel="stylesheet" href="/shop21/lib/tailwind.css">
    <script src="/shop21/lib/jquery.min.js"></script>
    <link rel="stylesheet" href="/shop21/lib/all.min.css">
    <script src="/shop21/lib/jquery.suggestions.min.js"></script>
    <link href="/shop21/lib/suggestions.min.css" rel="stylesheet" />
    <script src="https://api-maps.yandex.ru/2.1/?apikey=3f537f51-ad8a-45a1-ad5d-768f40314a3e&lang=ru_RU" type="text/javascript"></script>
    <!-- STRUCTURED-DATA-START -->
    <!-- STRUCTURED-DATA-END -->
    <style>
        /* --- Общие стили --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap');

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            -webkit-user-select: none; /* Safari */
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* IE 10+ and Edge */
            user-select: none; /* Standard syntax */
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Разрешить выделение для полей ввода */
        input, textarea {
            -webkit-user-select: text; /* Safari */
            -moz-user-select: text; /* Firefox */
            -ms-user-select: text; /* IE 10+ and Edge */
            user-select: text; /* Standard syntax */
        }

        /* Отключить контекстное меню для изображений товаров */
        .product-card .product-image, .product-detail-view img {
            pointer-events: none;
        }

        .search-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }
        .cart-badge {
            position: absolute; top: -8px; right: -8px; font-size: 10px;
            background-color: #EF4444; color: white; border-radius: 50%;
            width: 20px; height: 20px; display: flex; align-items: center;
            justify-content: center; font-weight: bold;
        }
        .skeleton {
            animation: pulse 1.5s infinite ease-in-out;
            background-color: #e5e7eb;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        .modal { transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        
        #toast-container {
            position: fixed; bottom: 70px; left: 50%; transform: translateX(-50%);
            z-index: 1000; display: flex; flex-direction: column; align-items: center; gap: 10px;
        }
        .toast {
            background-color: rgba(0,0,0,0.75); color: white; padding: 10px 20px;
            border-radius: 20px; font-size: 0.9em; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            opacity: 0; transform: translateY(20px); transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .toast.show { opacity: 1; transform: translateY(0); }

        .nav-item.active i, .nav-item.active span {
            color: #3B82F6; 
        }
        
        /* Стили для страницы профиля */
        .profile-info-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e5e7eb; /* gray-200 */
        }
        .profile-info-item:last-child {
            border-bottom: none;
        }
        .profile-info-item i {
            color: #6b7280; /* gray-500 */
            width: 20px; /* Фиксированная ширина для иконок */
            text-align: center;
        }
        .profile-info-item span {
            color: #374151; /* gray-700 */
        }
         .profile-info-item a {
            color: #3B82F6; /* blue-500 */
            text-decoration: none;
        }
        .profile-info-item a:hover {
            text-decoration: underline;
        }

        .order-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 12px;
            padding: 16px;
        }
        .order-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .order-card-header h3 {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
        }
        .order-card-header .status {
            font-size: 0.9em;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 4px;
        }
        .status-new { background-color: #e0f7fa; color: #00796b; } /* Teal */
        .status-processing { background-color: #fff3e0; color: #e65100; } /* Orange */
        .status-completed { background-color: #e8f5e9; color: #388e3c; } /* Green */
        .status-cancelled { background-color: #ffebee; color: #d32f2f; } /* Red */
        .order-item {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            color: #555;
            margin-bottom: 4px;
        }
        .order-total {
            font-size: 1em;
            font-weight: 600;
            text-align: right;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #eee;
        }


        /* Стили для выпадающего списка подсказок */
        #suggestionsContainer {
            max-height: 200px; /* Ограничение высоты, чтобы список не был слишком длинным */
            overflow-y: auto; /* Добавляем скролл, если подсказок много */
        }
        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.9em;
            color: #374151; /* gray-700 */
        }
        .suggestion-item:hover {
            background-color: #f3f4f6; /* gray-100 */
        }
        .suggestion-item.active { /* Для выделения активной подсказки (например, при навигации стрелками) */
            background-color: #DBEAFE; /* blue-100 */
            color: #1D4ED8; /* blue-700 */
        }

        .category-tabs {
            position: fixed;
            bottom: 60px; /* Поднимаем над главным меню */
            left: 0;
            width: 100%;
            background-color: #ffffff;
            border-top: 1px solid #e5e7eb;
            padding: 8px 4px;
            overflow-x: auto;
            white-space: nowrap;
            z-index: 19; /* Ниже чем шапка и меню, но выше контента */
            -webkit-overflow-scrolling: touch; /* Плавный скролл на iOS */
        }
        .category-tabs::-webkit-scrollbar {
            display: none; /* Скрываем скроллбар */
        }
        .tab {
            display: inline-block;
            padding: 6px 14px;
            margin: 0 4px;
            font-size: 0.9em;
            color: #374151; /* gray-700 */
            background-color: #f3f4f6; /* gray-100 */
            border-radius: 16px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            border: 1px solid transparent;
        }
        .tab.active {
            background-color: #3B82F6; /* blue-500 */
            color: white;
            font-weight: 600;
            border-color: #2563EB; /* blue-600 */
        }
        .tab:hover:not(.active) {
            background-color: #e5e7eb; /* gray-200 */
        }

        /* Desktop Styles */
        @media (min-width: 1024px) {
            #desktop-sidebar { display: flex; }
            #mobile-nav { display: none; }
            #productDetailFooter { display: none; } /* Hide on desktop */
            .category-tabs {
                position: static;
                bottom: auto;
                border-top: none;
                padding: 0;
                margin-bottom: 1rem;
                z-index: auto;
            }
            main { 
                padding-bottom: 1rem !important; 
                height: 100vh;
                overflow-y: auto;
            }
            header { max-width: 100% !important; }
        }

        #productDetailFooter {
            transition: transform 0.3s ease-in-out;
            transform: translateY(100%);
        }
        #productDetailFooter.show {
            transform: translateY(0);
        }

        /* Стили для модального окна политики конфиденциальности */
        #privacyPolicyModal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        #privacyPolicyModal .modal-content {
            transition: transform 0.3s ease;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        #privacyPolicyModal .modal-body {
            overflow-y: auto;
            padding-right: 1rem; /* для скроллбара */
        }
        #privacyPolicyModal h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        #privacyPolicyModal h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        .product-description {
            white-space: pre-wrap; /* Сохраняем переносы строк */
        }
        #privacyPolicyModal p, #privacyPolicyModal ul {
            margin-bottom: 1rem;
            color: #4b5563; /* gray-600 */
        }
        #privacyPolicyModal ul {
            list-style-type: disc;
            padding-left: 1.5rem;
        }
        .delivery-option {
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        }
        .delivery-option.active {
            background-color: #DBEAFE; /* blue-100 */
            border-color: #3B82F6; /* blue-500 */
            color: #1D4ED8; /* blue-700 */
            font-weight: 600;
        }
        .loader-spinner {
            border: 2px solid #f3f3f3; /* Light grey */
            border-top: 2px solid #3B82F6; /* blue-500 */
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tariff-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border: 1px solid #e5e7eb; /* gray-200 */
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .tariff-option.active {
            background-color: #DBEAFE; /* blue-100 */
            border-color: #3B82F6; /* blue-500 */
        }
        .tariff-option:not(.active):hover {
            background-color: #f9fafb; /* gray-50 */
        }

        /* --- Стили для новой карточки --- */
        .product-card {
            background-color: #fff;
            width: 100%; /* Адаптивно */
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
            cursor: pointer;
        }
        .card-image-container {
            position: relative;
            background: linear-gradient(180deg, #cce7f5 0%, #a4d8f2 100%);
        }
        .product-image {
            display: block;
            width: 100%;
            height: 160px; /* Фиксированная высота для единообразия */
            object-fit: cover;
        }
        .card-tags {
            position: absolute;
            bottom: 8px;
            left: 8px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            align-items: flex-start;
        }
        .tag {
            color: #fff;
            font-weight: 700;
            border-radius: 8px;
            padding: 4px 8px;
            font-size: 12px;
        }
        .tag-discount {
            background-color: #f53b57;
            font-size: 14px;
        }
        .card-info {
            padding: 12px;
            background-color: #fff;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        .price-section {
            display: flex;
            align-items: baseline;
            gap: 6px;
            margin-bottom: 4px;
        }
        .current-price {
            font-size: 20px;
            font-weight: 700;
            color: #2f3640;
        }
        .original-price {
            font-size: 14px;
            color: #8c8c8c;
            text-decoration: line-through;
        }
        .product-title {
            font-size: 14px;
            font-weight: 400;
            color: #2f3640;
            margin: 0 0 6px 0;
            flex-grow: 1; /* Занимает доступное пространство */
            line-height: 1.3;
            height: 3.9em; /* 3 строки */
            overflow: hidden;
        }
        .status-section {
            font-size: 12px;
            margin-bottom: 8px;
        }
        .action-button {
            background: #a259ff;
            color: #fff;
            border: none;
            width: 100%;
            padding: 10px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s ease;
            margin-top: auto; /* Прижимает кнопку к низу */
        }
        .action-button:hover {
            background: #8e44ad;
        }
        .action-button svg {
            width: 20px;
            height: 20px;
            fill: #fff;
        }

        .header-custom-bg {
            background-color: #a259ff;
        }
        .btn-custom-bg {
            background-color: #a259ff;
        }
        .btn-custom-bg:hover {
            background-color: #8e44ad;
        }
    </style>
    <script>
        (function() {
            const currentBuildVersion = document.querySelector('meta[name="build-version"]').getAttribute('content');
            const lastKnownBuildVersion = localStorage.getItem('lastKnownBuildVersion');

            if (lastKnownBuildVersion && lastKnownBuildVersion !== currentBuildVersion) {
                console.log('New build detected. Clearing local storage and reloading.');
                localStorage.clear();
                localStorage.setItem('lastKnownBuildVersion', currentBuildVersion); // Save new version before reload
                window.location.reload(true); // Force reload from server
            } else if (!lastKnownBuildVersion) {
                localStorage.setItem('lastKnownBuildVersion', currentBuildVersion);
            }
        })();
    </script>
</head>
<body class="bg-gray-100 font-sans lg:flex">

    <!-- Desktop Sidebar -->
    <aside id="desktop-sidebar" class="hidden lg:flex flex-col w-64 bg-white shadow-lg h-screen sticky top-0">
        <div class="px-6 py-4 border-b">
            <h2 class="text-2xl font-bold text-blue-600 flex items-center"><i class="fas fa-store mr-3"></i>Мой магазин</h2>
        </div>
        <nav class="flex-grow p-4 space-y-2">
            <button id="desktopNavHome" class="nav-item w-full flex items-center text-gray-600 p-3 rounded-lg hover:bg-gray-100">
                <i class="fas fa-home text-xl w-8"></i>
                <span class="text-base font-medium">Главная</span>
            </button>
            <button id="desktopNavCategories" class="nav-item w-full flex items-center text-gray-600 p-3 rounded-lg hover:bg-gray-100">
                <i class="fas fa-th-large text-xl w-8"></i>
                <span class="text-base font-medium">Категории</span>
            </button>
            <button id="desktopNavCart" class="nav-item w-full flex items-center text-gray-600 p-3 rounded-lg hover:bg-gray-100 relative">
                <i class="fas fa-shopping-bag text-xl w-8"></i>
                <span class="text-base font-medium">Корзина</span>
                <div id="cartBadgeDesktop" class="cart-badge hidden" style="top: 4px; right: 12px;">0</div>
            </button>
            <button id="desktopNavProfile" class="nav-item w-full flex items-center text-gray-600 p-3 rounded-lg hover:bg-gray-100">
                <i class="fas fa-user text-xl w-8"></i>
                <span class="text-base font-medium">Профиль</span>
            </button>
        </nav>
    </aside>

    <div id="mobile-container" class="w-full lg:flex-1 bg-white min-h-screen lg:shadow-lg relative overflow-hidden max-w-md mx-auto lg:max-w-full">
        <!-- Шапка -->
        <header class="header-custom-bg text-white p-4 fixed top-0 w-full max-w-md lg:static lg:max-w-full z-20 shadow-md lg:shadow-none lg:border-b">
            <div class="flex items-center w-full">
                <div class="flex items-center">
                    <button id="backButton" class="text-white p-1 rounded-full hover:bg-blue-700 hidden -ml-1" aria-label="Назад">
                        <i class="fas fa-arrow-left text-xl"></i>
                    </button>
                    <i id="storeIcon" class="fas fa-store text-2xl ml-2 lg:hidden"></i>
                    <h1 id="headerTitle" class="text-xl font-bold ml-2 hidden">Мой магазин</h1>
                </div>
                <div id="searchContainer" class="relative hidden flex-grow ml-3">
                    <input type="text" id="searchInput" placeholder="Поиск товаров..." 
                        class="w-full py-2.5 px-4 pr-16 rounded-full text-gray-800 focus:outline-none search-input shadow-sm" autocomplete="off">
                    <button id="clearSearchButton" class="absolute right-10 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 hidden" aria-label="Очистить поиск">
                        <i class="fas fa-times-circle text-lg"></i>
                    </button>
                    <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    
                    <div id="suggestionsContainer" class="absolute left-0 right-0 mt-1 bg-white border border-gray-300 rounded-md shadow-lg z-30 hidden">
                        {/* Сюда будут добавляться подсказки */}
                    </div>
                </div>
                <button id="headerInstallButton" class="text-white p-2 rounded-full hover:bg-blue-700 hidden ml-auto relative" aria-label="Установить приложение">
                    <i class="fas fa-download text-xl"></i>
                    <div id="installTooltip" class="hidden">Установите приложение!</div>
                </button>
            </header>

        <main id="main-scroll-area" class="pb-24 pt-20 lg:pt-4"> 
            <div id="mainContentArea" class="px-4"></div>
            <div id="noContentMessage" class="text-center py-10 text-gray-500 hidden">
                <i class="fas fa-box-open text-4xl text-gray-300 mb-3"></i>
                <p>Здесь пока ничего нет.</p>
            </div>
            <div id="loadingIndicator" class="text-center py-10">
                <i class="fas fa-spinner fa-spin text-4xl text-blue-500 mb-3"></i>
                <p class="text-gray-600">Загрузка...</p>
            </div>
            <div id="loadMoreContainer" class="px-4 py-6 text-center hidden">
                <button id="loadMoreButton" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-6 rounded-full shadow-md transition duration-150 ease-in-out">
                    Загрузить еще
                </button>
                <div id="loadingMoreIndicator" class="text-center py-2 hidden">
                    <i class="fas fa-spinner fa-spin text-2xl text-blue-500"></i>
                </div>
            </div>
        </main>

        <!-- Product Detail Footer -->
        <div id="productDetailFooter" class="fixed bottom-0 w-full max-w-md bg-white p-3 z-20" style="bottom: 70px; border-top: 1px solid #e5e7eb;">
            <button id="footerAddToCartBtn" class="w-full btn-custom-bg text-white font-bold py-3 px-4 rounded-lg transition duration-150 ease-in-out flex items-center justify-center text-lg">
                В корзину
            </button>
        </div>

        <!-- Нижнее меню -->
        <nav id="mobile-nav" class="fixed bottom-0 w-full max-w-md bg-white border-t border-gray-200 flex justify-around py-2 z-20">
            <button id="navHome" class="nav-item flex flex-col items-center text-gray-500 p-2" aria-label="Главная">
                <i class="fas fa-home text-xl"></i>
                <span class="text-xs mt-1">Главная</span>
            </button>
            <button id="navCategories" class="nav-item flex flex-col items-center text-gray-500 p-2" aria-label="Категории">
                <i class="fas fa-th-large text-xl"></i>
                <span class="text-xs mt-1">Категории</span>
            </button>
            <button id="cartIconBottomNav" class="nav-item flex flex-col items-center text-gray-500 p-2 relative" aria-label="Корзина">
                <i class="fas fa-shopping-bag text-xl"></i>
                <span class="text-xs mt-1">Корзина</span>
                <div id="cartBadgeBottomNav" class="cart-badge hidden" style="top: -2px; right: 10px;">0</div>
            </button>
            <button id="navProfile" class="nav-item flex flex-col items-center text-gray-500 p-2" aria-label="Профиль">
                <i class="fas fa-user text-xl"></i>
                <span class="text-xs mt-1">Профиль</span>
            </button>
        </nav>
    </div>

    

    <div id="toast-container"></div>

    <!-- Privacy Policy Modal -->
    <div id="privacyPolicyModal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-[1001] hidden opacity-0 visibility-hidden">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-2xl transform scale-95">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 class="text-xl font-semibold text-gray-800">Политика конфиденциальности</h2>
                <button id="closePrivacyModal" class="text-gray-500 hover:text-gray-800 p-2 rounded-full">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="modal-body p-6 text-sm">
                <!-- Содержимое будет вставлено из privacy-policy.html -->
            </div>
        </div>
    </div>

    


    <script>
        // const SCRIPT_URL = '...';
        
        // Функция для очистки текста от символов с ошибками кодировки
        function cleanText(text) {
            if (!text) return '';
            
            // Удаляем только проблемные символы, сохраняя HTML-разметку
            return text
                .replace(/�/g, '') // Удаляем символы замены Unicode
                .replace(/\uFFFD/g, '') // Удаляем символы замены Unicode (другой вариант)
                .trim();
        }
        
        const productDetailFooterEl = document.getElementById('productDetailFooter');
        const mainContentAreaEl = document.getElementById('mainContentArea');
        const searchContainerEl = document.getElementById('searchContainer');
        const searchInputEl = document.getElementById('searchInput');
        const clearSearchButtonEl = document.getElementById('clearSearchButton');
        const suggestionsContainerEl = document.getElementById('suggestionsContainer');
        const cartBadgeBottomNavEl = document.getElementById('cartBadgeBottomNav');
        const cartBadgeDesktopEl = document.getElementById('cartBadgeDesktop');
        const noContentMessageEl = document.getElementById('noContentMessage');
        const loadingIndicatorEl = document.getElementById('loadingIndicator');
        const headerTitleEl = document.getElementById('headerTitle');
        const backButtonEl = document.getElementById('backButton');
        const storeIconEl = document.getElementById('storeIcon');
        const headerInstallButton = document.getElementById('headerInstallButton'); 

        const cartIconBottomNavButtonEl = document.getElementById('cartIconBottomNav');
        const toastContainerEl = document.getElementById('toast-container');

        const navHomeBtn = document.getElementById('navHome');
        const navCategoriesBtn = document.getElementById('navCategories');
        const navProfileBtn = document.getElementById('navProfile');
        const navCartBtn = document.getElementById('cartIconBottomNav');
        const desktopNavHomeBtn = document.getElementById('desktopNavHome');
        const desktopNavCategoriesBtn = document.getElementById('desktopNavCategories');
        const desktopNavCartBtn = document.getElementById('desktopNavCart');
        const desktopNavProfileBtn = document.getElementById('desktopNavProfile');
        
        const loadMoreContainerEl = document.getElementById('loadMoreContainer');
        const loadMoreButtonEl = document.getElementById('loadMoreButton');
        const loadingMoreIndicatorEl = document.getElementById('loadingMoreIndicator');

        let allProductsCache = []; 
        let categoriesCache = null;
        let cart = {}; // Загрузим из localStorage позже
        let currentView = 'home';
        let currentCategory = null;
        let previousViewHistory = []; 
        let currentProductId = null;
        let currentProductSlug = null;
        let scrollPositions = {};
        let selectedDeliveryMethod = 'pickup'; // 'pickup' or 'delivery'
        let selectedTariff = 'fast'; // 'fast' or 'standard'
        let inputFocusedToAllowScrollBlur = false;
        let lastCalculatedAddress = null; // Добавляем для кэширования адреса

        const hideKeyboardOnTouchMove = () => {
            if (inputFocusedToAllowScrollBlur && document.activeElement === searchInputEl) {
                searchInputEl.blur(); 
            }
        };

        searchInputEl.addEventListener('focus', () => {
            inputFocusedToAllowScrollBlur = true;
            window.addEventListener('touchmove', hideKeyboardOnTouchMove, { passive: true });
            // Показываем подсказки, если в поле уже есть текст (например, после выбора подсказки и продолжения редактирования)
            const searchTerm = searchInputEl.value.trim();
            if (searchTerm.length >= 2 && suggestionsContainerEl.children.length > 0) {
                 suggestionsContainerEl.classList.remove('hidden');
            }
        });

        searchInputEl.addEventListener('blur', () => {
            inputFocusedToAllowScrollBlur = false;
            window.removeEventListener('touchmove', hideKeyboardOnTouchMove);
            setTimeout(() => {
                if (!suggestionsContainerEl.matches(':hover') && !searchInputEl.matches(':focus')) { 
                    suggestionsContainerEl.classList.add('hidden');
                }
            }, 150);
        });

        let currentPage = 1;
        let totalPages = 1;
        let productsPerPage = 10; 
        let isLoadingMore = false;
        let totalProductsCount = 0;
        let viewCache = {}; 

        const storeInfo = {
            name: "Продукты у дома \"Солнышко\"",
            address: "г. Примерный, ул. Центральная, д. 15А",
            mapLink: "https://yandex.ru/maps/?text=г. Примерный, ул. Центральная, д. 15А",
            phone: "+7 (999) 123-45-67",
            phoneLink: "tel:+79991234567",
            email: "info@solnyshko-shop.ru",
            emailLink: "mailto:info@solnyshko-shop.ru",
            hours: "Пн-Сб: 09:00 - 21:00, Вс: 10:00 - 20:00",
            social: [],
            description: "Свежие продукты, напитки и товары для дома каждый день! Мы рады предложить вам широкий ассортимент качественных товаров по доступным ценам. Заходите к нам или заказывайте онлайн!"
        };

        function showLoadingIndicator(show, isInitialLoad = true) {
            if (isInitialLoad) {
                loadingIndicatorEl.classList.toggle('hidden', !show);
                if (show) mainContentAreaEl.innerHTML = '';
                if (show) noContentMessageEl.classList.add('hidden');
                loadMoreContainerEl.classList.add('hidden');
            } else { 
                const aboutToLoadValidPage = currentPage <= totalPages;
                const shouldShowLoaderUI = show && aboutToLoadValidPage;

                loadMoreContainerEl.classList.toggle('hidden', !shouldShowLoaderUI);
                loadingMoreIndicatorEl.classList.toggle('hidden', !shouldShowLoaderUI);

                if (loadMoreButtonEl) loadMoreButtonEl.classList.add('hidden');
            }
            if(isInitialLoad && show) noContentMessageEl.classList.add('hidden');
        }
        function showNoContentMessage(message = "Здесь пока ничего нет.") {
            mainContentAreaEl.innerHTML = ''; 
            noContentMessageEl.querySelector('p').textContent = message;
            noContentMessageEl.classList.remove('hidden');
            loadingIndicatorEl.classList.add('hidden');
        }
        function updateHeaderUI() {
            const showSearch = currentView === 'home' || currentView === 'productDetail';
            searchContainerEl.classList.toggle('hidden', !showSearch);

            const showBackButton = currentView === 'myCabinet' || currentView === 'aboutStore' || currentView === 'productDetail' || currentView === 'categories' || currentView === 'cart' || (currentView === 'home' && currentCategory);
            backButtonEl.classList.toggle('hidden', !showBackButton);

            const showStoreIcon = !(currentView === 'home' && currentCategory) && currentView !== 'cart' && currentView !== 'aboutStore' && currentView !== 'myCabinet' && currentView !== 'profile';
            storeIconEl.classList.toggle('hidden', !showStoreIcon);

            if (currentView === 'profile') {
                 if (headerTitleEl) {
                    headerTitleEl.textContent = 'Профиль';
                    headerTitleEl.classList.remove('hidden');
                }
            } else if (currentView === 'myCabinet') {
                if (headerTitleEl) {
                    headerTitleEl.textContent = 'Мой кабинет';
                    headerTitleEl.classList.remove('hidden');
                }
            } else if (currentView === 'aboutStore') {
                if (headerTitleEl) {
                    headerTitleEl.textContent = 'О магазине';
                    headerTitleEl.classList.remove('hidden');
                }
            } else if (currentView === 'categories') {
                if (headerTitleEl) {
                    headerTitleEl.textContent = 'Категории';
                    headerTitleEl.classList.remove('hidden');
                }
            } else if (currentView === 'cart') {
                if (headerTitleEl) {
                    headerTitleEl.textContent = 'Корзина';
                    headerTitleEl.classList.remove('hidden');
                }
            } else if (currentView === 'home' && currentCategory) {
                if (headerTitleEl) {
                    headerTitleEl.textContent = currentCategory;
                    headerTitleEl.classList.remove('hidden');
                }
            } else {
                if (headerTitleEl) {
                    headerTitleEl.classList.add('hidden');
                }
            }
            
            if (headerInstallButton && headerInstallButton.dataset.shouldShow === 'true') {
                 headerInstallButton.classList.remove('hidden');
            } else if (headerInstallButton) {
                 headerInstallButton.classList.add('hidden');
            }
        }
        function updateActiveNavButton() {
            // Reset all nav items first
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.classList.remove('active', 'bg-blue-50', 'text-blue-600');
                btn.classList.add('text-gray-600');
            });
             document.querySelectorAll('#mobile-nav .nav-item i, #mobile-nav .nav-item span').forEach(el => {
                el.style.color = ''; // Reset mobile icon/text color
            });


            let activeMobileBtn, activeDesktopBtn;
            if (currentView === 'home') {
                activeMobileBtn = navHomeBtn;
                activeDesktopBtn = desktopNavHomeBtn;
            } else if (currentView === 'categories') {
                activeMobileBtn = navCategoriesBtn;
                activeDesktopBtn = desktopNavCategoriesBtn;
            } else if (currentView === 'profile') {
                activeMobileBtn = navProfileBtn;
                activeDesktopBtn = desktopNavProfileBtn;
            } else if (currentView === 'cart') {
                activeMobileBtn = navCartBtn;
                activeDesktopBtn = desktopNavCartBtn;
            }
            
            // Style active mobile button
            if (activeMobileBtn) {
                activeMobileBtn.classList.add('active');
                activeMobileBtn.querySelectorAll('i, span').forEach(el => {
                     el.style.color = '#3B82F6';
                });
            }

            // Style active desktop button
            if (activeDesktopBtn) {
                activeDesktopBtn.classList.add('active', 'bg-blue-50', 'text-blue-600');
                activeDesktopBtn.classList.remove('text-gray-600');
            }
        }
        function navigateTo(view, data = null, cameFromBackButton = false) {
            if (currentView) {
                scrollPositions[currentView] = window.scrollY;
            }

            if (view !== 'home' && !data?.keepCategory) {
                currentCategory = null;
            }

            const newPath = view === 'productDetail' && data.productSlug ? `/product/${data.productSlug}` : '/';
            if (!cameFromBackButton && window.location.pathname !== newPath) {
                history.pushState({ view, data }, '', newPath);
            }
            
            const oldView = currentView;
            const oldViewProductId = (oldView === 'productDetail') ? currentProductId : null;

            if (!cameFromBackButton) {
                if (oldView && oldView !== view) {
                    const entryToPush = { view: oldView };
                    if (oldViewProductId) {
                        entryToPush.productId = oldViewProductId;
                    }
                    if (oldView === 'home' && currentCategory) {
                        entryToPush.category = currentCategory;
                    }

                    const lastHistoryEntry = previousViewHistory[previousViewHistory.length - 1];
                    if (!lastHistoryEntry ||
                        lastHistoryEntry.view !== entryToPush.view ||
                        (lastHistoryEntry.productId || null) !== (entryToPush.productId || null) ||
                        (lastHistoryEntry.category || null) !== (entryToPush.category || null)
                    ) {
                        previousViewHistory.push(entryToPush);
                    }
                }
            }
            
            currentView = view;
            if (view === 'productDetail' && data) {
                currentProductId = data.productId || null;
                currentProductSlug = data.productSlug || null;
                productDetailFooterEl.classList.add('show');
                mainContentAreaEl.style.paddingBottom = '150px'; // Space for both footers
            } else {
                currentProductId = null;
                currentProductSlug = null;
                productDetailFooterEl.classList.remove('show');
                mainContentAreaEl.style.paddingBottom = ''; // Reset padding
                if (view === 'home') {
                    document.title = 'Мой магазин';
                } else if (view === 'profile') {
                    document.title = 'Профиль - Мой магазин';
                } else if (view === 'myCabinet') {
                    document.title = 'Мой кабинет - Мой магазин';
                } else if (view === 'aboutStore') {
                    document.title = 'О магазине - Мой магазин';
                } else if (view === 'notFound') {
                    document.title = '404 - Страница не найдена';
                }
            }

            updateHeaderUI(); 
            updateActiveNavButton(); 
            
            const viewCacheKey = view; 
            let shouldReloadViewContent = true;

            if (viewCache[viewCacheKey] && view === 'home' && !data?.forceReload && !searchInputEl.value.trim()) { // Не используем кэш если есть поисковый запрос
                console.log(`Restoring ${viewCacheKey} from cache.`);
                allProductsCache = viewCache[viewCacheKey].products;
                currentPage = viewCache[viewCacheKey].currentPage;
                totalPages = viewCache[viewCacheKey].totalPages;
                totalProductsCount = viewCache[viewCacheKey].totalProductsCount;
                productsPerPage = viewCache[viewCacheKey].productsPerPage;
                
                mainContentAreaEl.innerHTML = ''; 
                noContentMessageEl.classList.add('hidden');
                displayProducts(allProductsCache, true); 

                if (currentPage < totalPages) loadMoreContainerEl.classList.remove('hidden');
                else loadMoreContainerEl.classList.add('hidden');
                
                showLoadingIndicator(false, true); 
                shouldReloadViewContent = false;
                if (scrollPositions[viewCacheKey] !== undefined) {
                     requestAnimationFrame(() => window.scrollTo(0, scrollPositions[viewCacheKey]));
                }
            } else if (view !== 'productDetail') { 
                allProductsCache = []; 
                currentPage = 1;
                loadMoreContainerEl.classList.add('hidden'); 
                mainContentAreaEl.innerHTML = ''; 
                noContentMessageEl.classList.add('hidden'); 
                if (view !== 'profile') showLoadingIndicator(true, true); 
            }


            if (shouldReloadViewContent) {
                if (view === 'home') {
                    fetchAndDisplayProducts(true); 
                } else if (view === 'categories') {
                    displayCategoriesView();
                } else if (view === 'profile') {
                    displayProfileInfo();
                } else if (view === 'myCabinet') {
                    displayMyCabinetView();
                } else if (view === 'aboutStore') {
                    displayAboutStoreInfo();
                } else if (view === 'cart') {
                    displayCartView();
                } else if (view === 'productDetail') {
                    if (currentProductId || currentProductSlug) {
                        renderProductDetailView(currentProductId, currentProductSlug);
                    } else {
                        showNoContentMessage("Ошибка: Идентификатор товара не указан.");
                    }
                } else if (view === 'notFound') {
                    displayNotFoundView();
                }
            }
            
            if (shouldReloadViewContent || scrollPositions[viewCacheKey] === undefined) {
                 if (!cameFromBackButton || scrollPositions[viewCacheKey] === undefined) { 
                    window.scrollTo(0, 0);
                 }
            }
        }
        
        function getStatus(quantityDisplay) {
            const quantity = parseInt(quantityDisplay, 10);

            if (isNaN(quantity)) {
                const lowerCaseDisplay = (quantityDisplay || '').toLowerCase();
                if (lowerCaseDisplay === 'скоро появится' || lowerCaseDisplay === 'закончился' || lowerCaseDisplay === '0' || lowerCaseDisplay === '0 шт.') {
                    return { text: 'Скоро появится', color: 'text-red-500 font-semibold' };
                }
                if (lowerCaseDisplay === 'осталось мало' || lowerCaseDisplay === '1-5 шт.' || lowerCaseDisplay === 'очень мало') {
                    return { text: 'Осталось мало', color: 'text-orange-500' };
                }
                if(lowerCaseDisplay) {
                    return { text: 'В наличии', color: 'text-green-600' };
                }
                return { text: '', color: '' };
            }

            if (quantity <= 0) {
                return { text: 'Скоро появится', color: 'text-red-500 font-semibold' };
            }
            if (quantity <= 5) {
                return { text: 'Осталось мало', color: 'text-orange-500' };
            }
            return { text: 'В наличии', color: 'text-green-600' };
        }

        async function fetchAndDisplayProducts(isInitialLoad = true) {
            if (isLoadingMore && !isInitialLoad) return; 
            
            const viewCacheKey = currentView; 

            if (isInitialLoad) {
                currentPage = 1; 
                allProductsCache = []; 
                mainContentAreaEl.innerHTML = ''; 
                showLoadingIndicator(true, true);
            } else {
                isLoadingMore = true;
                showLoadingIndicator(true, false); 
            }

            try {
                const searchTerm = searchInputEl.value.trim(); 
                let apiUrl = `https://ikeber-pricelist.vercel.app/api/products?page=${currentPage}&limit=${productsPerPage}`;
                
                if (searchTerm) {
                   apiUrl += `&search=${encodeURIComponent(searchTerm)}`;
                } else if (currentCategory) {
                   apiUrl += `&category=${encodeURIComponent(currentCategory)}`;
                }


                const response = await fetch(apiUrl);
                if (!response.ok) {
                    let errorData; try { errorData = await response.json(); } catch (e) {}
                    throw new Error(`HTTP error ${response.status}. ${errorData?.message || ''}`);
                }
                const data = await response.json();

                // Abort if view has changed since the fetch was initiated.
                if (currentView !== 'home') {
                    console.log(`[Render Abort] View changed. Was fetching product list, but now on ${currentView}.`);
                    isLoadingMore = false; // Reset loading flag
                    return;
                }

                if (data && data.products) {
                    const newProducts = data.products.map(p => ({...p, price: parseFloat(p.price) || 0 }));
                    
                    if (isInitialLoad) {
                        allProductsCache = newProducts;
                    } else {
                        newProducts.forEach(np => {
                            if (!allProductsCache.find(op => op.id === np.id)) {
                                allProductsCache.push(np);
                            }
                        });
                    }
                    
                    productsPerPage = data.limit;
                    totalPages = data.totalPages;
                    totalProductsCount = data.totalProducts;
                    currentPage = data.currentPage; 

                    if (!searchTerm) { // Кэшируем только если нет поискового запроса
                        viewCache[viewCacheKey] = {
                            products: [...allProductsCache], 
                            currentPage: currentPage,
                            totalPages: totalPages,
                            totalProductsCount: totalProductsCount,
                            productsPerPage: productsPerPage
                        };
                    }
                                        
                    displayProducts(allProductsCache, isInitialLoad); 

                    if (allProductsCache.length === 0 && isInitialLoad) {
                         showNoContentMessage(searchTerm ? "Товары по вашему запросу не найдены." : "Товары не найдены.");
                    }

                } else if (data && data.error) {
                     throw new Error(data.message || data.error || 'Ошибка от сервера');
                } else { 
                    if (isInitialLoad && (!data || !data.products || data.products.length === 0)) {
                        allProductsCache = [];
                        displayProducts([], true); 
                        loadMoreContainerEl.classList.add('hidden'); 
                        if (allProductsCache.length === 0) { 
                           showNoContentMessage(searchInputEl.value.trim() ? "Товары по вашему запросу не найдены." : "Товары не найдены.");
                        }
                    } else if (!isInitialLoad && (!data || !data.products || data.products.length === 0)) {
                        totalPages = currentPage; 
                        loadMoreContainerEl.classList.add('hidden');
                    } else {
                       throw new Error('Неожиданный формат данных от сервера'); 
                    }
                }
            } catch (error) {
                console.error('Ошибка при загрузке товаров:', error);
                showToast(`Ошибка загрузки: ${error.message}`, 'error');
                if (isInitialLoad) {
                    showNoContentMessage("Не удалось загрузить товары.");
                } else {
                    if (currentPage > 1) { 
                        currentPage--;
                        console.log('Ошибка при дозагрузке, currentPage откачен на:', currentPage);
                    }
                }
            } finally {
                if (isInitialLoad) {
                    showLoadingIndicator(false, true);
                } else {
                    isLoadingMore = false;
                    showLoadingIndicator(false, false);
                }
            }
        }

        async function loadMoreProducts() {
            if (currentPage < totalPages && !isLoadingMore) {
                currentPage++;
                await fetchAndDisplayProducts(false); 
            }
        }

        function displayProducts(productsToRender, isNewProductSet = true) {
            let filteredProducts = productsToRender; 
            
            if (isNewProductSet) {
                mainContentAreaEl.innerHTML = '';
            }

            if (filteredProducts.length === 0 && isNewProductSet) { 
                const currentSearchTerm = searchInputEl.value.trim(); 
                showNoContentMessage(currentSearchTerm ? "Товары по вашему запросу не найдены." : "Товары не найдены.");
                loadMoreContainerEl.classList.add('hidden'); 
                showLoadingIndicator(false, true); 
                return;
            } else if (filteredProducts.length === 0 && !isNewProductSet) {
                 showLoadingIndicator(false, false); 
                return;
            }
            
            const fragment = document.createDocumentFragment();
            let productGrid = mainContentAreaEl.querySelector('.product-grid');
            if (!productGrid) {
                 productGrid = document.createElement('div');
                 productGrid.className = 'grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 product-grid'; 
                 fragment.appendChild(productGrid);
            }


            productsToRender.forEach(product => {
                if (productGrid.querySelector(`[data-product-id-card="${product.id}"]`)) {
                    return; 
                }

                const productCardElement = document.createElement('div'); 
                productCardElement.className = 'product-card';
                productCardElement.setAttribute('data-product-id-card', product.id);
                
                const basePrice = Math.floor(product.price);
                const discountPercentage = product.discountPercentage ? parseFloat(product.discountPercentage) : 0;
                let marketingPrice = 0;
                let discountTagHtml = '';

                if (discountPercentage > 0) {
                    marketingPrice = Math.floor(basePrice * (1 + discountPercentage / 100));
                    discountTagHtml = `<div class="tag tag-discount">-${discountPercentage}%</div>`;
                }

                const status = getStatus(product.quantityDisplay);
                
                const now = new Date();
                const buttonText = now.getHours() < 14 ? 'Сегодня' : 'Завтра';

                productCardElement.innerHTML = `
                    <div class="card-image-container">
                        <img src="${product.imageUrl || 'https://via.placeholder.com/320x160?text=No+Image'}" alt="${product.name}" class="product-image">
                        <div class="card-tags">
                            ${discountTagHtml}
                        </div>
                    </div>
                    <div class="card-info">
                        <div class="price-section">
                            <span class="current-price">${basePrice} ₽</span>
                            ${marketingPrice > 0 ? `<span class="original-price">${marketingPrice} ₽</span>` : ''}
                        </div>
                        <h3 class="product-title">${product.name}</h3>
                        <div class="status-section">
                            <p class="${status.color}">${status.text}</p>
                        </div>
                        <button data-product-id="${product.id}" class="action-button add-to-cart-btn">
                            <svg viewBox="0 0 24 24"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49A1.003 1.003 0 0020 4H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/></svg>
                            <span>${buttonText}</span>
                        </button>
                    </div>
                `;
                productCardElement.querySelector('.add-to-cart-btn').addEventListener('click', (e) => { e.stopPropagation(); handleAddToCart(product.id); });
                productCardElement.addEventListener('click', () => navigateToProductDetail(product.id, product.slug));
                productGrid.appendChild(productCardElement);
            });

            if (isNewProductSet) { 
                 mainContentAreaEl.appendChild(fragment);
            }
            
            showLoadingIndicator(false, isNewProductSet); 
        }
        
        function displayCategoriesView(forceRefresh = false) {
            const renderCategories = (categories) => {
                showLoadingIndicator(false);
                const container = document.createElement('div');
                container.className = 'p-2 space-y-2';

                const allCatEl = document.createElement('a');
                allCatEl.href = '#';
                allCatEl.className = 'block p-4 bg-white rounded-lg shadow-sm hover:bg-gray-50 transition-colors';
                allCatEl.innerHTML = `<div class="flex items-center"><i class="fas fa-boxes mr-3 text-blue-500"></i><span class="font-medium text-gray-800">Все товары</span></div>`;
                allCatEl.onclick = (e) => {
                    e.preventDefault();
                    currentCategory = null;
                    navigateTo('home', { forceReload: true });
                };
                container.appendChild(allCatEl);

                categories.forEach(category => {
                    const categoryEl = document.createElement('a');
                    categoryEl.href = '#';
                    categoryEl.className = 'block p-4 bg-white rounded-lg shadow-sm hover:bg-gray-50 transition-colors';
                    categoryEl.innerHTML = `<div class="flex items-center justify-between">
                                                <span class="font-medium text-gray-700">${category}</span>
                                                <i class="fas fa-chevron-right text-gray-400"></i>
                                            </div>`;
                    categoryEl.onclick = (e) => {
                        e.preventDefault();
                        currentCategory = category;
                        navigateTo('home', { forceReload: true, keepCategory: true });
                    };
                    container.appendChild(categoryEl);
                });
                mainContentAreaEl.innerHTML = '';
                mainContentAreaEl.appendChild(container);
            };

            if (categoriesCache && !forceRefresh) {
                renderCategories(categoriesCache);
                return;
            }

            showLoadingIndicator(true);
            mainContentAreaEl.innerHTML = '';
            fetch('https://ikeber-pricelist.vercel.app/api/categories')
                .then(response => {
                    if (!response.ok) throw new Error('Не удалось загрузить категории');
                    return response.json();
                })
                .then(categories => {
                    categoriesCache = categories; // Сохраняем в кэш
                    renderCategories(categories);
                })
                .catch(error => {
                    console.error('Ошибка при отображении категорий:', error);
                    showNoContentMessage('Не удалось загрузить категории.');
                });
        }

        function displayNotFoundView() {
            currentView = 'notFound';
            updateHeaderUI();
            mainContentAreaEl.innerHTML = `
                <div class="text-center p-8">
                    <i class="fas fa-exclamation-triangle text-6xl text-yellow-400 mb-6"></i>
                    <h1 class="text-4xl font-bold text-gray-800 mb-2">404</h1>
                    <p class="text-xl text-gray-600 mb-8">Страница не найдена</p>
                    <a href="/" onclick="event.preventDefault(); navigateTo('home');" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-8 rounded-full shadow-md transition duration-150 ease-in-out">
                        Вернуться на главную
                    </a>
                </div>
            `;
            showLoadingIndicator(false);
            noContentMessageEl.classList.add('hidden');
            loadMoreContainerEl.classList.add('hidden');
        }

        function displayProfileInfo() {
            mainContentAreaEl.innerHTML = `
                <div class="p-4 space-y-3">
                    <button id="myCabinetButton" class="w-full flex justify-between items-center text-left p-4 bg-white rounded-lg shadow-sm hover:bg-gray-50 transition-colors">
                        <span class="font-medium text-gray-700"><i class="fas fa-user-circle mr-3 text-blue-500"></i>Мой кабинет</span>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </button>

                    <button id="aboutStoreButton" class="w-full flex justify-between items-center text-left p-4 bg-white rounded-lg shadow-sm hover:bg-gray-50 transition-colors">
                        <span class="font-medium text-gray-700"><i class="fas fa-store mr-3 text-blue-500"></i>О магазине</span>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </button>
                </div>
            `;
            showLoadingIndicator(false);
            noContentMessageEl.classList.add('hidden');
            loadMoreContainerEl.classList.add('hidden');

            document.getElementById('myCabinetButton').addEventListener('click', () => navigateTo('myCabinet'));
            document.getElementById('aboutStoreButton').addEventListener('click', () => navigateTo('aboutStore'));
        }

        async function displayMyCabinetView() {
            mainContentAreaEl.innerHTML = `
                <div class="bg-white shadow rounded-lg p-6 mt-4">
                    <div id="customerInfo" class="space-y-3 mb-6">
                        <!-- Customer info will be loaded here -->
                    </div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-3 border-t pt-4">Мои заказы</h3>
                    <div id="ordersLoader" class="text-center py-4">
                        <i class="fas fa-spinner fa-spin text-2xl text-blue-500"></i>
                        <p class="text-gray-500 mt-2">Загружаем ваши заказы...</p>
                    </div>
                    <div id="customerOrdersContainer" class="space-y-4 hidden">
                        <!-- Customer orders will be loaded here -->
                    </div>
                    <div id="noOrdersMessage" class="text-center py-4 text-gray-500 hidden">
                        <i class="fas fa-box-open text-4xl text-gray-300 mb-3"></i>
                        <p>У вас пока нет заказов.</p>
                    </div>
                </div>
            `;
            showLoadingIndicator(false);
            noContentMessageEl.classList.add('hidden');
            loadMoreContainerEl.classList.add('hidden');

            const customerInfoEl = document.getElementById('customerInfo');
            const customerOrdersContainerEl = document.getElementById('customerOrdersContainer');
            const noOrdersMessageEl = document.getElementById('noOrdersMessage');
            const ordersLoaderEl = document.getElementById('ordersLoader');

            ordersLoaderEl.classList.remove('hidden');
            customerOrdersContainerEl.classList.add('hidden');
            noOrdersMessageEl.classList.add('hidden');

            try {
                const savedData = localStorage.getItem('orderFormData');
                if (!savedData) {
                    customerInfoEl.innerHTML = '<p class="text-gray-500 text-center">Данные клиента не найдены. Пожалуйста, оформите заказ.</p>';
                    noOrdersMessageEl.classList.remove('hidden');
                    ordersLoaderEl.classList.add('hidden');
                    return;
                }
                const formData = JSON.parse(savedData);
                const customerPhone = formData.phone;
                const customerName = formData.name;
                const customerEmail = formData.email || '';

                customerInfoEl.innerHTML = `
                    <div class="profile-info-item">
                        <i class="fas fa-user mr-3"></i>
                        <span>${customerName || 'Не указано'}</span>
                    </div>
                    <div class="profile-info-item">
                        <i class="fas fa-phone-alt mr-3"></i>
                        <span>${customerPhone || 'Не указано'}</span>
                    </div>
                    ${customerEmail ? `
                    <div class="profile-info-item">
                        <i class="fas fa-envelope mr-3"></i>
                        <span>${customerEmail}</span>
                    </div>` : ''}
                `;

                let apiUrl = `https://ikeber-pricelist.vercel.app/api/system?action=getCustomerOrders`;
                if (customerPhone) {
                    apiUrl += `&phone=${encodeURIComponent(customerPhone)}`;
                } else if (customerEmail) {
                    apiUrl += `&email=${encodeURIComponent(customerEmail)}`;
                } else {
                    noOrdersMessageEl.classList.remove('hidden');
                    ordersLoaderEl.classList.add('hidden');
                    return;
                }

                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error('Не удалось загрузить заказы клиента.');
                }
                const data = await response.json();

                ordersLoaderEl.classList.add('hidden');
                customerOrdersContainerEl.classList.remove('hidden');

                if (data.orders && data.orders.length > 0) {
                    saveCustomerOrdersToLocalStorage(data.orders);
                    renderOrders(data.orders, customerOrdersContainerEl, noOrdersMessageEl);
                } else {
                    noOrdersMessageEl.classList.remove('hidden');
                }

            } catch (error) {
                console.error('Ошибка при загрузке заказов клиента:', error);
                showToast('Не удалось обновить заказы. Показываю сохраненные данные.', 'error');
                
                ordersLoaderEl.classList.add('hidden');
                customerOrdersContainerEl.classList.remove('hidden');

                let customerOrders = loadCustomerOrdersFromLocalStorage();
                if (customerOrders.length > 0) {
                    renderOrders(customerOrders, customerOrdersContainerEl, noOrdersMessageEl);
                } else {
                    customerOrdersContainerEl.innerHTML = `<p class="text-red-500 text-center">Не удалось загрузить ваши заказы. Проверьте интернет-соединение.</p>`;
                }
            }
        }

        function renderOrders(orders, container, noOrdersMessageEl) {
            container.innerHTML = ''; // Очищаем контейнер перед рендерингом
            if (orders.length === 0) {
                noOrdersMessageEl.classList.remove('hidden');
                return;
            }
            noOrdersMessageEl.classList.add('hidden'); // Скрываем, если есть заказы

            [...orders].reverse().forEach(order => {
                const orderCard = document.createElement('div');
                orderCard.className = 'order-card';
                
                let statusClass = '';
                switch (order.status) {
                    case 'Новый': statusClass = 'status-new'; break;
                    case 'В обработке': statusClass = 'status-processing'; break;
                    case 'Выполнен': statusClass = 'status-completed'; break;
                    case 'Отменен': statusClass = 'status-cancelled'; break;
                    default: statusClass = '';
                }

                orderCard.innerHTML = `
                    <div class="order-card-header">
                        <h3>Заказ #${order.id}</h3>
                        <span class="status ${statusClass}">${order.status}</span>
                    </div>
                    <p class="text-sm text-gray-600 mb-2">Дата: ${order.date}</p>
                    <p class="text-sm text-gray-600 mb-2">Способ получения: ${order.deliveryMethod === 'pickup' ? 'Самовывоз' : 'Доставка'}</p>
                    ${order.deliveryMethod === 'delivery' && order.status !== 'Новый' ? `
                        <p class="text-sm text-gray-600 mb-2">Адрес: ${order.deliveryAddress}</p>
                        <p class="text-sm text-gray-600 mb-2">Тариф: ${order.deliveryTariff || 'не указан'}</p>
                        <p class="text-sm text-gray-600 mb-2">Стоимость доставки: ${order.deliveryCost} ₽</p>
                    ` : ''}
                    <div class="order-items-list mt-3">
                        ${order.items.map(item => `
                            <div class="order-item">
                                <span>${item.productName} (${item.quantity} шт.)</span>
                                <span>${Math.floor(item.price * item.quantity)} ₽</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="order-total">
                        Итого: ${Math.floor(order.totalAmount)} ₽
                    </div>
                `;
                container.appendChild(orderCard);
            });
        }

        function displayAboutStoreInfo() {
            mainContentAreaEl.innerHTML = `
                <div class="bg-white shadow rounded-lg p-6 mt-4">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-2 text-center">${storeInfo.name}</h2>
                    <p class="text-gray-600 text-sm text-center mb-6">${storeInfo.description}</p>
                    
                    <div class="space-y-3">
                        <div class="profile-info-item">
                            <i class="fas fa-map-marker-alt mr-3"></i>
                            <a href="${storeInfo.mapLink}" target="_blank" rel="noopener noreferrer"><span>${storeInfo.address}</span></a>
                        </div>
                        <div class="profile-info-item">
                            <i class="fas fa-phone-alt mr-3"></i>
                            <a href="${storeInfo.phoneLink}"><span>${storeInfo.phone}</span></a>
                        </div>
                        <div class="profile-info-item">
                            <i class="fas fa-envelope mr-3"></i>
                             <a href="${storeInfo.emailLink}"><span>${storeInfo.email}</span></a>
                        </div>
                        <div class="profile-info-item">
                            <i class="fas fa-clock mr-3"></i>
                            <span>${storeInfo.hours}</span>
                        </div>
                        ${storeInfo.social.map(s => `
                            <div class="profile-info-item">
                                <i class="${s.icon} mr-3"></i>
                                <a href="${s.link}" target="_blank" rel="noopener noreferrer"><span>${s.name}</span></a>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            showLoadingIndicator(false);
            noContentMessageEl.classList.add('hidden');
            loadMoreContainerEl.classList.add('hidden');
        }

        function navigateToProductDetail(productId, productSlug) {
            navigateTo('productDetail', { productId, productSlug }, false);
        }

        async function renderProductDetailView(productId, productSlug) {
            const render = (product) => {
                if (!product) return;

                document.title = product.name;

                const detailView = document.createElement('div');
                detailView.className = 'p-4 product-detail-view';

                let priceHtml = '';
                const basePrice = Math.floor(product.price);
                const discountPercentage = product.discountPercentage ? parseFloat(product.discountPercentage) : 0;

                if (discountPercentage > 0) {
                    const marketingPrice = Math.floor(basePrice * (1 + discountPercentage / 100));
                    priceHtml = `<div><p class="text-2xl font-bold text-gray-800">${basePrice} ₽</p><p class="text-sm text-gray-500 line-through">${marketingPrice} ₽</p></div>`;
                } else {
                    priceHtml = `<p class="text-2xl font-bold text-gray-800">${basePrice} ₽</p>`;
                }
                
                let quantityHtml = '';
                const status = getStatus(product.quantityDisplay);
                if (status.text) {
                    quantityHtml = `<p class="text-sm ${status.color} mb-3">Наличие: ${status.text}</p>`;
                }
                
                detailView.innerHTML = `
                    <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                        <img src="${product.imageUrl || 'https://via.placeholder.com/300?text=No+Image'}" alt="${product.name}" class="w-full h-64 object-cover">
                        <div class="p-6">
                            <h2 class="text-2xl font-semibold text-gray-800 mb-2">${product.name}</h2>
                            <div class="flex justify-between items-center mb-4">
                                ${priceHtml}
                                <button id="shareProductBtn" class="bg-transparent hover:bg-gray-100 text-gray-600 font-bold py-2 px-4 rounded-lg transition duration-150 ease-in-out flex items-center justify-center text-base border border-gray-300">
                                    <i class="fab fa-whatsapp mr-2"></i><span>Поделиться</span>
                                </button>
                            </div>
                            ${quantityHtml}
                ${product.description ? `<p class="text-gray-600 text-sm mb-6 product-description">${cleanText(product.description)}</p>` : ''}
                        </div>
                    </div>
                `;
                mainContentAreaEl.innerHTML = ''; // Clear previous content
                mainContentAreaEl.appendChild(detailView);

                // Setup the new footer button
                const footerBtn = document.getElementById('footerAddToCartBtn');
                if (footerBtn) {
                    // Clone and replace to remove old event listeners
                    const newFooterBtn = footerBtn.cloneNode(true);
                    footerBtn.parentNode.replaceChild(newFooterBtn, footerBtn);
                    newFooterBtn.addEventListener('click', () => {
                        handleAddToCart(product.id);
                    });
                }

                document.getElementById('shareProductBtn').addEventListener('click', () => {
                    const productUrl = `${window.location.origin}/product/${product.slug}`;
                    const shareText = `Посмотри, какой товар я нашел: ${product.name}! ${productUrl}`;
                    const whatsappUrl = `whatsapp://send?text=${encodeURIComponent(shareText)}`;
                    window.location.href = whatsappUrl;
                });
            };

            // Пытаемся найти товар в кэше для мгновенной загрузки
            const cachedProduct = allProductsCache.find(p => String(p.id) === String(productId));

            if (cachedProduct) {
                showLoadingIndicator(false);
                render(cachedProduct);
            } else {
                showLoadingIndicator(true);
            }

            // Всегда запрашиваем свежие данные из сети
            try {
                const apiUrl = productSlug ? `https://ikeber-pricelist.vercel.app/api/products?slug=${productSlug}` : `https://ikeber-pricelist.vercel.app/api/products?id=${productId}`;
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    if (response.status === 404) {
                        navigateTo('notFound', null, true);
                        return;
                    }
                    throw new Error(`Ошибка сервера: ${response.statusText}`);
                }
                const freshProduct = await response.json();

                // Abort if view has changed since the fetch was initiated.
                if (currentView !== 'productDetail' || String(productId) !== String(currentProductId)) {
                    console.log(`[Render Abort] View changed. Was fetching ${productId}, but now on ${currentView} (${currentProductId}).`);
                    return;
                }

                // Обновляем кэш
                const cacheIndex = allProductsCache.findIndex(p => String(p.id) === String(productId));
                if (cacheIndex !== -1) {
                    allProductsCache[cacheIndex] = freshProduct;
                } else {
                    allProductsCache.push(freshProduct);
                }

                // Перерисовываем со свежими данными
                showLoadingIndicator(false);
                render(freshProduct);

            } catch (error) {
                console.error('Ошибка при загрузке данных о товаре:', error);
                if (!cachedProduct) { // Показываем ошибку, только если ничего не было отрисовано
                    showNoContentMessage(error.message || "Не удалось загрузить информацию о товаре.");
                }
            } finally {
                showLoadingIndicator(false);
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            if (type === 'success') toast.style.backgroundColor = '#10B981';
            else if (type === 'error') toast.style.backgroundColor = '#EF4444';
            toast.textContent = message;
            toastContainerEl.appendChild(toast);
            toast.offsetHeight; 
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => { toast.remove(); }, 300);
            }, 2500);
        }
        function handleAddToCart(productId) {
            const product = allProductsCache.find(p => String(p.id) === String(productId)) || 
                            (cart[productId] ? cart[productId].product : null); // Ищем и в корзине, если нет в allProductsCache (например, товар был загружен ранее, но не виден сейчас)
            if (!product) {
                console.warn("Не удалось найти товар для добавления в корзину, ID:", productId);
                showToast("Ошибка: товар не найден", "error");
                return;
            }
            if (cart[productId]) cart[productId].quantity++;
            else cart[productId] = { product: { ...product }, quantity: 1 };
            saveCartToLocalStorage();
            updateCartBadge();
            showToast(`${product.name} добавлен в корзину`);
        }

        function saveCartToLocalStorage() {
            try {
                localStorage.setItem('shoppingCart', JSON.stringify(cart));
            } catch (e) {
                console.error("Ошибка сохранения корзины в localStorage:", e);
                showToast("Не удалось сохранить корзину локально.", "error");
            }
        }

        function loadCartFromLocalStorage() {
            try {
                const savedCart = localStorage.getItem('shoppingCart');
                if (savedCart) {
                    cart = JSON.parse(savedCart);
                    // Важно: после загрузки, если товары в корзине не содержат полных данных о продукте
                    // (например, если мы сохраняли только ID и количество),
                    // может потребоваться дополнительная логика для "гидратации" этих данных
                    // из allProductsCache или через API, если это необходимо для отображения.
                    // В текущей реализации мы сохраняем объект product целиком, так что это не должно быть проблемой.
                } else {
                    cart = {};
                }
            } catch (e) {
                console.error("Ошибка загрузки корзины из localStorage:", e);
                cart = {}; // Сбрасываем корзину в случае ошибки
                showToast("Не удалось загрузить сохраненную корзину.", "error");
            }
        }

        function updateCartBadge() {
            const totalItems = Object.values(cart).reduce((sum, item) => sum + item.quantity, 0);
            const badgeElements = [cartBadgeBottomNavEl, cartBadgeDesktopEl];
            badgeElements.forEach(badge => {
                if (badge) {
                    if (totalItems > 0) {
                        badge.textContent = totalItems;
                        badge.style.display = 'flex'; // Показываем как flex
                    } else {
                        badge.textContent = ''; // Очищаем текст
                        badge.style.display = 'none'; // Полностью скрываем
                    }
                }
            });
        }

        async function displayCartView() {
            mainContentAreaEl.innerHTML = '';
            showLoadingIndicator(false);
            const cartContainer = document.createElement('div');
            cartContainer.className = 'p-4';
            cartContainer.innerHTML = `
                <div id="cart-items-container" class="space-y-2"></div>
                <div class="mt-4 pt-4 border-t">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Способ получения</label>
                        <div class="flex space-x-2">
                            <button id="deliveryPickup" class="delivery-option flex-1 text-center p-2 border rounded-md text-sm">
                                <i class="fas fa-walking mr-1"></i> Самовывоз
                            </button>
                            <button id="deliveryShip" class="delivery-option flex-1 text-center p-2 border rounded-md text-sm">
                                <i class="fas fa-truck mr-1"></i> Доставка
                            </button>
                        </div>
                    </div>
                    <div id="pickupAddressContainer" class="bg-blue-50 p-4 rounded-md mb-4">
                        <p class="font-medium text-blue-800">Адрес магазина:</p>
                        <p id="pickupAddressDisplay" class="text-sm text-gray-700 mt-1"></p>
                    </div>
    
                    <form id="orderForm" novalidate>
                        <button type="button" id="toggleCustomerDetails" class="w-full text-left font-medium text-gray-700 mb-3 p-3 rounded-md bg-gray-100 hover:bg-gray-200 flex justify-between items-center transition-colors">
                            <span><i class="fas fa-user-edit mr-2 text-gray-500"></i>Данные для заказа</span>
                            <i class="fas fa-chevron-down transition-transform"></i>
                        </button>
                        <div id="customerDetailsContainer" class="hidden space-y-3 mb-3">
                            <div class="mb-3">
                                <label for="customerName" class="block text-sm font-medium text-gray-700 mb-1">Ваше имя</label>
                                <input type="text" id="customerName" name="customerName" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div class="mb-3">
                                <label for="customerPhone" class="block text-sm font-medium text-gray-700 mb-1">Телефон</label>
                                <input type="tel" id="customerPhone" name="customerPhone" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="+7 (XXX) XXX-XX-XX">
                            </div>
                            <div id="deliveryAddressContainer" class="hidden mb-3">
                                <label for="customerAddress" class="block text-sm font-medium text-gray-700 mb-1">Адрес доставки</label>
                                <input type="text" id="customerAddress" name="customerAddress" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Город, улица, дом, квартира">
                            </div>
                        </div>
    
                        <div id="cart-summary" class="space-y-1 text-right mb-4 border-t pt-4 mt-4">
                            <p>Сумма заказа: <span id="cart-subtotal" class="font-medium">0</span> руб.</p>
                            <div id="deliveryTariffsContainer" class="hidden space-y-2 my-2 text-left">
                                <!-- Тарифы будут вставлены сюда -->
                            </div>
                            
                            </div>
                            <p class="text-lg font-semibold border-t pt-1 mt-1">Итого: <span id="cart-total" class="text-blue-600">0</span> руб.<span id="delivery-text" class="text-sm text-gray-600"> + доставка</span></p>
                        </div>
    
                        <div class="mb-4 text-sm text-gray-700">
                            <input type="checkbox" id="privacyPolicyCheckbox" name="privacyPolicy" class="mr-2 align-middle">
                            <label for="privacyPolicyCheckbox" class="align-middle">Я согласен с <a href="#" id="privacyLink" class="text-blue-600 hover:underline">политикой конфиденциальности</a></label>
                        </div>
                        <button id="submitOrderButton" type="button" class="w-full btn-custom-bg text-white font-bold py-2.5 px-4 rounded-md transition duration-150 ease-in-out">Оформить заказ</button>
                    </form>
                    <div id="formMessage" class="mt-3 text-sm text-center"></div>
                </div>
            `;
            mainContentAreaEl.appendChild(cartContainer);
            renderCartItems();
            loadOrderFormData();
            loadPrivacyPolicyState();
            updateDeliveryMethodUI();
            loadAndDisplayPickupAddress();

            document.getElementById('deliveryPickup').addEventListener('click', () => setDeliveryMethod('pickup'));
            document.getElementById('deliveryShip').addEventListener('click', () => setDeliveryMethod('delivery'));
 
            // Проверяем статус доставки и обновляем UI
            try {
                const response = await fetch('https://ikeber-pricelist.vercel.app/api/system?action=getSettings');
                const data = await response.json();
                if (data.deliveryEnabled === false) {
                    const deliveryOption = document.getElementById('deliveryShip');
                    if (deliveryOption) {
                        deliveryOption.style.display = 'none';
                    }
                    // Если доставка отключена, принудительно выбираем самовывоз
                    if (selectedDeliveryMethod === 'delivery') {
                        setDeliveryMethod('pickup');
                    }
                }
            } catch (error) {
                console.error('Error fetching delivery settings:', error);
            }
 
            // Add event listeners to save form data on input
            document.getElementById('customerName').addEventListener('input', saveOrderFormData);
            const phoneInput = document.getElementById('customerPhone');
            phoneInput.addEventListener('input', (e) => {
                e.target.value = formatPhoneNumber(e.target.value);
                saveOrderFormData();
            });
            document.getElementById('customerAddress').addEventListener('input', saveOrderFormData);
            document.getElementById('privacyPolicyCheckbox').addEventListener('change', savePrivacyPolicyState);
 
            document.getElementById('toggleCustomerDetails').addEventListener('click', function() {
                const container = document.getElementById('customerDetailsContainer');
                const icon = this.querySelector('.fa-chevron-down');
                const isHidden = container.classList.contains('hidden');
                
                if (isHidden) {
                    container.classList.remove('hidden');
                    icon.style.transform = 'rotate(180deg)';
                } else {
                    container.classList.add('hidden');
                    icon.style.transform = '';
                }
            });

            document.getElementById('submitOrderButton').addEventListener('click', handleSubmitOrder);
            document.getElementById('privacyLink').addEventListener('click', (e) => {
                e.preventDefault();
                openPrivacyPolicyModal();
            });

            // Инициализация подсказок DaData
            const addressInput = $("#customerAddress");
            addressInput.suggestions({
                token: "a0109719d33e23422ca2771981d42c98b8123099",
                type: "ADDRESS",
                onSelect: function(suggestion) {
                    addressInput.val(suggestion.value);
                    saveOrderFormData(); // Сохраняем адрес сразу
                    displayDeliveryTariffs();
                }
            });
        }

        async function calculateAndShowDeliveryCost(customerAddress) {
            if (!customerAddress) {
                document.getElementById('deliveryTariffsContainer').classList.add('hidden');
                renderCartItems();
                return;
            }
            
            displayDeliveryTariffs();
            saveOrderFormData();
        }

        function displayDeliveryTariffs() {
            const tariffsContainer = document.getElementById('deliveryTariffsContainer');
            if (!tariffsContainer) return;

            tariffsContainer.innerHTML = `
                <div class="text-center p-4 bg-blue-50 rounded-md">
                    <p class="font-medium text-blue-800">Стоимость доставки:</p>
                    <p class="text-2xl font-bold text-blue-600 mt-2">от 199 руб.</p>
                   
                </div>
            `;
            tariffsContainer.classList.remove('hidden');
            renderCartItems();
        }

        function selectTariff(tariffKey, cost) {
            // Упрощенная функция - больше не нужна для выбора тарифов
            renderCartItems();
            saveOrderFormData();
        }

        async function loadAndDisplayPickupAddress() {
            try {
                const response = await fetch('https://ikeber-pricelist.vercel.app/api/cart-helpers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'get_store_info' })
                });
                if (!response.ok) {
                    throw new Error('Failed to fetch store address');
                }
                const data = await response.json();
                const pickupAddressDisplay = document.getElementById('pickupAddressDisplay');
                if (pickupAddressDisplay) {
                    pickupAddressDisplay.textContent = data.address;
                }
            } catch (error) {
                console.error('Error loading pickup address:', error);
                const pickupAddressDisplay = document.getElementById('pickupAddressDisplay');
                if (pickupAddressDisplay) {
                    pickupAddressDisplay.textContent = 'Адрес не загружен';
                }
            }
        }

        function renderCartItems() {
            const cartItemsContainer = document.getElementById('cart-items-container');
            const cartSubtotalEl = document.getElementById('cart-subtotal');
            const cartTotalEl = document.getElementById('cart-total');
            const submitOrderButtonEl = document.getElementById('submitOrderButton');
            const paymentBreakdownEl = document.getElementById('payment-breakdown');
            const paymentNowEl = document.getElementById('payment-now');
            const paymentLaterEl = document.getElementById('payment-later');
            const deliveryTariffsContainerEl = document.getElementById('deliveryTariffsContainer');

            cartItemsContainer.innerHTML = '';
            const subtotal = Object.values(cart).reduce((sum, item) => sum + (item.product.price * item.quantity), 0);

            if (Object.keys(cart).length === 0) {
                cartItemsContainer.innerHTML = '<p class="text-gray-500 text-center">Ваша корзина пуста.</p>';
                if(cartSubtotalEl) cartSubtotalEl.textContent = "0";
                if(cartTotalEl) cartTotalEl.textContent = "0";
                if(submitOrderButtonEl) submitOrderButtonEl.disabled = true;
                if(deliveryTariffsContainerEl) deliveryTariffsContainerEl.classList.add('hidden');
                if(paymentBreakdownEl) paymentBreakdownEl.classList.add('hidden');
                return;
            }
            
            // Проверяем наличие адреса в localStorage
            const savedData = localStorage.getItem('orderFormData');
            const hasAddress = savedData && JSON.parse(savedData).address;
            
            // Скрываем тарифы если корзина пуста или нет адреса
            if (deliveryTariffsContainerEl) {
                deliveryTariffsContainerEl.classList.toggle('hidden', 
                    !hasAddress || selectedDeliveryMethod !== 'delivery');
            }
            
            if(submitOrderButtonEl) submitOrderButtonEl.disabled = false;

            Object.values(cart).forEach(cartItem => {
                const itemEl = document.createElement('div');
                itemEl.className = 'flex justify-between items-center py-2 border-b';
                const itemTotal = cartItem.product.price * cartItem.quantity;
                itemEl.innerHTML = `
                    <div class="flex-grow min-w-0">
                        <p class="font-medium text-gray-800 truncate">${cartItem.product.name}</p>
                        <p class="text-sm text-gray-500">
                            <button class="cart-decrease px-2 py-1 text-red-500" data-id="${cartItem.product.id}"><i class="fas fa-minus-circle"></i></button>
                            <span class="mx-2">${cartItem.quantity}</span>
                            <button class="cart-increase px-2 py-1 text-green-500" data-id="${cartItem.product.id}"><i class="fas fa-plus-circle"></i></button>
                            x ${Math.floor(cartItem.product.price)} ₽
                        </p>
                    </div>
                    <div class="flex items-center">
                        <span class="font-semibold text-gray-800 mr-4">${Math.floor(itemTotal)} ₽</span>
                        <button class="cart-remove p-1 text-gray-400 hover:text-red-600" data-id="${cartItem.product.id}"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `;
                itemEl.querySelector('.cart-decrease').addEventListener('click', () => updateCartItemQuantity(cartItem.product.id, -1));
                itemEl.querySelector('.cart-increase').addEventListener('click', () => updateCartItemQuantity(cartItem.product.id, 1));
                itemEl.querySelector('.cart-remove').addEventListener('click', () => {
                    delete cart[cartItem.product.id];
                    saveCartToLocalStorage();
                    renderCartItems();
                    updateCartBadge();
                });
                cartItemsContainer.appendChild(itemEl);
            });

            if (selectedDeliveryMethod === 'delivery' && Object.keys(cart).length > 0) {
                if (paymentBreakdownEl) paymentBreakdownEl.classList.remove('hidden');
                if (paymentNowEl) paymentNowEl.textContent = `199 руб.`;
            } else {
                if (paymentBreakdownEl) paymentBreakdownEl.classList.add('hidden');
            }

            if(cartSubtotalEl) cartSubtotalEl.textContent = Math.floor(subtotal);
            if(cartTotalEl) cartTotalEl.textContent = Math.floor(subtotal);
            
            // Обновляем текст "доставка" в зависимости от способа получения
            const deliveryTextEl = document.getElementById('delivery-text');
            if (deliveryTextEl) {
                if (selectedDeliveryMethod === 'pickup') {
                    deliveryTextEl.style.display = 'none';
                } else {
                    deliveryTextEl.style.display = 'inline';
                }
            }
        }

        function updateCartItemQuantity(productId, change) {
            if (cart[productId]) {
                cart[productId].quantity += change;
                if (cart[productId].quantity <= 0) {
                    delete cart[productId];
                }
            }
            saveCartToLocalStorage();
            renderCartItems();
            updateCartBadge();
        }

        async function handleSubmitOrder(event) {
            event.preventDefault();
            const formMessageEl = document.getElementById('formMessage');
            if (Object.keys(cart).length === 0) { 
                formMessageEl.textContent = 'Ваша корзина пуста.'; 
                formMessageEl.className = 'mt-3 text-sm text-center text-red-500'; 
                return; 
            }
            
            const customerNameInput = document.getElementById('customerName');
            const customerPhoneInput = document.getElementById('customerPhone');
            const privacyPolicyCheckbox = document.getElementById('privacyPolicyCheckbox');
            const submitOrderButtonEl = document.getElementById('submitOrderButton');
            const customerDetailsContainer = document.getElementById('customerDetailsContainer');
            const toggleCustomerDetailsButton = document.getElementById('toggleCustomerDetails');

            const customerName = customerNameInput.value.trim();
            const customerPhone = customerPhoneInput.value.trim();

            // Последовательная валидация полей
            if (!customerName) {
                formMessageEl.textContent = 'Пожалуйста, укажите ваше имя.';
                formMessageEl.className = 'mt-3 text-sm text-center text-red-500';
                if (customerDetailsContainer.classList.contains('hidden')) {
                    toggleCustomerDetailsButton.click();
                }
                customerNameInput.focus();
                return;
            }
 
            if (!customerPhone) {
                formMessageEl.textContent = 'Пожалуйста, укажите ваш номер телефона.';
                formMessageEl.className = 'mt-3 text-sm text-center text-red-500';
                if (customerDetailsContainer.classList.contains('hidden')) {
                    toggleCustomerDetailsButton.click();
                }
                customerPhoneInput.focus();
                return;
            }
 
            if (!validatePhoneNumber(customerPhone)) {
                formMessageEl.textContent = 'Пожалуйста, введите корректный номер телефона (например, +7 912 345-67-89).';
                formMessageEl.className = 'mt-3 text-sm text-center text-red-500';
                if (customerDetailsContainer.classList.contains('hidden')) {
                    toggleCustomerDetailsButton.click();
                }
                customerPhoneInput.focus();
                return;
            }

            const customerAddressInput = document.getElementById('customerAddress');
            if (selectedDeliveryMethod === 'delivery' && !customerAddressInput.value.trim()) {
                formMessageEl.textContent = 'Пожалуйста, укажите адрес доставки.';
                formMessageEl.className = 'mt-3 text-sm text-center text-red-500';
                if (customerDetailsContainer.classList.contains('hidden')) {
                    toggleCustomerDetailsButton.click();
                }
                customerAddressInput.focus();
                return;
            }
 
            if (!privacyPolicyCheckbox.checked) {
                formMessageEl.textContent = 'Пожалуйста, согласитесь с политикой конфиденциальности.';
                formMessageEl.className = 'mt-3 text-sm text-center text-red-500';
                const privacyLabel = privacyPolicyCheckbox.parentElement;
                privacyLabel.classList.add('animate-pulse');
                setTimeout(() => {
                    privacyLabel.classList.remove('animate-pulse');
                }, 2000);
                return;
            }
            
            submitOrderButtonEl.disabled = true;
            submitOrderButtonEl.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Отправка...';
            formMessageEl.textContent = '';
            
            const itemsForOrder = Object.values(cart).map(item => ({
                id: item.product.id,
                name: item.product.name,
                quantity: item.quantity,
                price: item.product.price
            }));
            const subtotal = Object.values(cart).reduce((sum, item) => sum + (item.product.price * item.quantity), 0);
            const customerAddress = document.getElementById('customerAddress').value.trim();
  
             const orderPayload = {
                 customerName,
                 customerPhone,
                 customerEmail: '', // Keep the key for compatibility with the backend if needed, but send it empty.
                 items: JSON.stringify(itemsForOrder),
                 totalAmount: subtotal,
                 deliveryMethod: selectedDeliveryMethod,
                 deliveryAddress: customerAddressInput.value.trim(),
                 deliveryCost: 199,
                 deliveryTariff: selectedTariff
             };

            try {
                const response = await fetch('https://ikeber-pricelist.vercel.app/api/submit-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderPayload)
                });

                if (!response.ok) {
                    let errorData;
                    try { errorData = await response.json(); } catch (e) {}
                    throw new Error(`HTTP error ${response.status}. ${errorData?.message || ''}`);
                }
                
                const result = await response.json();

            if (result.status === 'success') {
                formMessageEl.textContent = `Заказ #${result.orderId} успешно оформлен! С вами свяжутся в ближайшее время.`;
                formMessageEl.className = 'mt-3 text-sm text-center text-green-600';
                cart = {};
                saveCartToLocalStorage();
                updateCartBadge();
                const deliveryTariffsContainerEl = document.getElementById('deliveryTariffsContainer');
                if (deliveryTariffsContainerEl) deliveryTariffsContainerEl.classList.add('hidden');
                // document.getElementById('orderForm').reset(); // Не сбрасываем поля

                // Добавляем новый заказ в локальный кэш
                const newOrder = {
                    id: result.orderId,
                    date: new Date().toLocaleString('ru-RU', { timeZone: 'Asia/Yekaterinburg', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false }).replace(' г.,', '').replace(',', ' в'),
                    customerName: orderPayload.customerName,
                    customerPhone: orderPayload.customerPhone,
                    customerEmail: orderPayload.customerEmail,
                    items: itemsForOrder,
                    totalAmount: subtotal,
                    status: "Новый",
                    deliveryAddress: orderPayload.deliveryAddress,
                    deliveryCost: orderPayload.deliveryCost,
                    deliveryMethod: orderPayload.deliveryMethod,
                    deliveryTariff: orderPayload.deliveryTariff
                };
                let existingOrders = loadCustomerOrdersFromLocalStorage();
                existingOrders.unshift(newOrder); // Добавляем новый заказ в начало списка
                saveCustomerOrdersToLocalStorage(existingOrders);

                setTimeout(() => {
                    navigateTo('myCabinet'); // Переходим в "Мой кабинет", чтобы увидеть новый заказ
                    showToast("Заказ принят!", "success");
                }, 3000);
                } else {
                    throw new Error(result.message || 'Неизвестная ошибка сервера.');
                }
            } catch (error) {
                console.error('Ошибка при отправке заказа:', error);
                formMessageEl.textContent = `Ошибка: ${error.message}. Попробуйте еще раз.`;
                formMessageEl.className = 'mt-3 text-sm text-center text-red-500';
            } finally {
                submitOrderButtonEl.disabled = false;
                updateDeliveryMethodUI(); // Восстанавливаем текст кнопки
            }
        }

        function setDeliveryMethod(method) {
            selectedDeliveryMethod = method;
            const tariffsContainer = document.getElementById('deliveryTariffsContainer');
            const paymentBreakdown = document.getElementById('payment-breakdown');
            
            if (method === 'pickup') {
                if (tariffsContainer) tariffsContainer.classList.add('hidden');
                if (paymentBreakdown) paymentBreakdown.classList.add('hidden');
                document.getElementById('pickupAddressContainer').classList.remove('hidden');
            } else {
                // Показываем тарифы доставки
                displayDeliveryTariffs();
                if (paymentBreakdown) paymentBreakdown.classList.remove('hidden');
                document.getElementById('pickupAddressContainer').classList.add('hidden');
            }
            saveOrderFormData();
            updateDeliveryMethodUI();
            renderCartItems();
            
            // Обновляем текст "доставка" в зависимости от способа получения
            const deliveryTextEl = document.getElementById('delivery-text');
            if (deliveryTextEl) {
                if (selectedDeliveryMethod === 'pickup') {
                    deliveryTextEl.style.display = 'none';
                } else {
                    deliveryTextEl.style.display = 'inline';
                }
            }
        }

        function updateDeliveryMethodUI() {
            const pickupBtn = document.getElementById('deliveryPickup');
            const shipBtn = document.getElementById('deliveryShip');
            const submitBtn = document.getElementById('submitOrderButton');

            if (!pickupBtn || !shipBtn || !submitBtn) return;
            const addressContainer = document.getElementById('deliveryAddressContainer');
 
            pickupBtn.classList.toggle('active', selectedDeliveryMethod === 'pickup');
            shipBtn.classList.toggle('active', selectedDeliveryMethod === 'delivery');
            
            if (addressContainer) {
                addressContainer.classList.toggle('hidden', selectedDeliveryMethod !== 'delivery');
            }
 
            if (submitBtn.disabled) return; // Не меняем текст, если кнопка в состоянии загрузки
 
            if (selectedDeliveryMethod === 'pickup') {
                submitBtn.innerHTML = '<i class="fas fa-walking mr-2"></i>Забрать в магазине';
            } else {
                submitBtn.innerHTML = '<i class="fas fa-truck mr-2"></i>Заказать доставку';
            }
        }
 
        function formatPhoneNumber(value) {
            if (!value) return value;
            const phoneNumber = value.replace(/\D/g, '');
            const phoneNumberLength = phoneNumber.length;
 
            if (phoneNumberLength < 2) {
                if (phoneNumber === '7' || phoneNumber === '8') return '+7';
                return `+7 (${phoneNumber}`;
            }
            
            let number = phoneNumber;
            if (number.startsWith('8')) {
                number = '7' + number.slice(1);
            }
            if (!number.startsWith('7')) {
                number = '7' + number;
            }
            number = number.substring(0, 11); // Ограничиваем длину
            
            let formattedNumber = '+7';
            if (number.length > 1) {
                formattedNumber += ' (' + number.substring(1, 4);
            }
            if (number.length >= 5) {
                formattedNumber += ') ' + number.substring(4, 7);
            }
            if (number.length >= 8) {
                formattedNumber += '-' + number.substring(7, 9);
            }
            if (number.length >= 10) {
                formattedNumber += '-' + number.substring(9, 11);
            }
            
            return formattedNumber;
        }
 
        function validatePhoneNumber(phone) {
            // Удаляем все нецифровые символы
            const digitsOnly = phone.replace(/\D/g, '');
            // Проверяем, что номер начинается с 7 или 8 и имеет 11 цифр
            if (/^[78]\d{10}$/.test(digitsOnly)) {
                return true;
            }
            return false;
        }
 
        // --- Search Suggestions Logic ---
        function displaySearchSuggestions(suggestions) {
            suggestionsContainerEl.innerHTML = ''; 
            if (suggestions && suggestions.length > 0) {
                suggestions.forEach(suggestion => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    item.textContent = suggestion.name; 
                    item.addEventListener('mousedown', (e) => { // Используем mousedown, чтобы сработало до blur инпута
                        e.preventDefault(); // Предотвращаем потерю фокуса инпутом до обработки клика
                        searchInputEl.value = suggestion.name;
                        suggestionsContainerEl.classList.add('hidden');
                        // Всегда переходим на главную страницу и выполняем поиск
                        navigateTo('home', { forceReload: true });
                    });
                    suggestionsContainerEl.appendChild(item);
                });
                suggestionsContainerEl.classList.remove('hidden');
            } else {
                suggestionsContainerEl.classList.add('hidden');
            }
        }

        // --- Event Listeners ---
        let searchDebounceTimer;
        
        searchInputEl.addEventListener('input', () => {
            clearTimeout(searchDebounceTimer);
            const searchTerm = searchInputEl.value.trim();
            clearSearchButtonEl.classList.toggle('hidden', searchTerm.length === 0);

            if (searchTerm.length < 2) {
                suggestionsContainerEl.classList.add('hidden');
                suggestionsContainerEl.innerHTML = '';
                // Если пользователь стер текст до <2 символов, но хочет видеть все товары,
                // можно инициировать загрузку всех товаров, если это желаемое поведение.
                // Пока оставим так: если меньше 2 символов, просто скрываем подсказки.
                // Полный поиск всех товаров произойдет при нажатии Enter с пустым полем или очистке.
                return; 
            }

            searchDebounceTimer = setTimeout(async () => {
                if (searchInputEl.value.trim().length >= 2) { // Повторная проверка, т.к. значение могло измениться
                    try {
                        const response = await fetch(`https://ikeber-pricelist.vercel.app/api/search-suggestions?q=${encodeURIComponent(searchInputEl.value.trim())}`);
                        if (!response.ok) {
                            console.error('Ошибка при загрузке подсказок:', response.status);
                            suggestionsContainerEl.classList.add('hidden');
                            return;
                        }
                        const suggestions = await response.json();
                        displaySearchSuggestions(suggestions);
                    } catch (error) {
                        console.error('Ошибка при запросе подсказок:', error);
                        suggestionsContainerEl.classList.add('hidden');
                    }
                } else {
                    suggestionsContainerEl.classList.add('hidden');
                    suggestionsContainerEl.innerHTML = '';
                }
            }, 200); // Уменьшена задержка debounce для более быстрого отклика
        });

        clearSearchButtonEl.addEventListener('click', () => {
            searchInputEl.value = '';
            clearSearchButtonEl.classList.add('hidden');
            suggestionsContainerEl.classList.add('hidden'); 
            suggestionsContainerEl.innerHTML = '';
            if (currentView === 'home') {
                window.scrollTo(0, 0); 
                currentPage = 1;
                allProductsCache = [];
                fetchAndDisplayProducts(true); 
            }
            searchInputEl.focus();
        });
        
        searchInputEl.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); 
                suggestionsContainerEl.classList.add('hidden'); 
                if (currentView === 'home') {
                    window.scrollTo(0, 0);
                    currentPage = 1;
                    allProductsCache = [];
                    fetchAndDisplayProducts(true); 
                }
            }
        });

        // Глобальный клик для скрытия подсказок
        document.addEventListener('click', function(event) {
            if (!searchContainerEl.contains(event.target)) {
                suggestionsContainerEl.classList.add('hidden');
            }
        });


        const goHome = () => {
            currentCategory = null;
            searchInputEl.value = '';
            clearSearchButtonEl.classList.add('hidden');
            
            // Неважно, где мы были, мы просто хотим перейти на чистую главную страницу.
            // forceReload гарантирует, что мы не будем использовать кэш вида, который мог быть отфильтрован.
            navigateTo('home', { forceReload: true });
        };

        navHomeBtn.addEventListener('click', goHome);
        desktopNavHomeBtn.addEventListener('click', goHome);
        navCategoriesBtn.addEventListener('click', () => navigateTo('categories'));
        desktopNavCategoriesBtn.addEventListener('click', () => navigateTo('categories'));
        navProfileBtn.addEventListener('click', () => navigateTo('profile'));
        desktopNavProfileBtn.addEventListener('click', () => navigateTo('profile'));
        desktopNavCartBtn.addEventListener('click', () => navigateTo('cart'));

        backButtonEl.addEventListener('click', () => {
            // Если мы на странице товаров отфильтрованных по категории, кнопка "назад" должна вести к списку всех категорий.
            if (currentView === 'home' && currentCategory) {
                currentCategory = null;
                navigateTo('categories', null, true);
                return;
            }

            const previousState = previousViewHistory.pop();
            if (previousState) {
                // Восстанавливаем категорию, если она была в предыдущем состоянии
                currentCategory = previousState.category || null;
                navigateTo(
                    previousState.view, 
                    { 
                        productId: previousState.productId,
                        productSlug: previousState.productSlug, // Также восстанавливаем slug
                        keepCategory: !!previousState.category 
                    }, 
                    true
                );
            } else {
                // Если истории нет, идем на главную
                navigateTo('home');
            }
        });
        cartIconBottomNavButtonEl.addEventListener('click', () => navigateTo('cart'));
        
        // Сохранение данных формы заказа в localStorage
        function saveOrderFormData() {
            try {
                const formData = {
                    name: document.getElementById('customerName').value,
                    phone: document.getElementById('customerPhone').value,
                    address: document.getElementById('customerAddress').value,
                    delivery: selectedDeliveryMethod,
                    selectedTariff: selectedTariff
                };
                localStorage.setItem('orderFormData', JSON.stringify(formData));
            } catch (e) {
                console.error("Ошибка сохранения данных формы заказа в localStorage:", e);
            }
        }

        function loadOrderFormData() {
            try {
                const savedData = localStorage.getItem('orderFormData');
                if (savedData) {
                    const formData = JSON.parse(savedData);
                    document.getElementById('customerName').value = formData.name || '';
                    document.getElementById('customerPhone').value = formData.phone || '';
                    const customerAddressInput = document.getElementById('customerAddress');
                    customerAddressInput.value = formData.address || '';
                    selectedDeliveryMethod = formData.delivery || 'pickup';
                    selectedTariff = formData.selectedTariff || 'fast';
                    lastCalculatedAddress = formData.address || null;

                    if (selectedDeliveryMethod === 'delivery' && Object.keys(cart).length > 0) {
                        displayDeliveryTariffs();
                    }
                    
                    // Обновляем текст "доставка" в зависимости от способа получения
                    const deliveryTextEl = document.getElementById('delivery-text');
                    if (deliveryTextEl) {
                        if (selectedDeliveryMethod === 'pickup') {
                            deliveryTextEl.style.display = 'none';
                        } else {
                            deliveryTextEl.style.display = 'inline';
                        }
                    }
                }
            } catch (e) {
                console.error("Ошибка загрузки данных формы заказа из localStorage:", e);
            }
        }

        function clearOrderFormData() {
            try {
                localStorage.removeItem('orderFormData');
            } catch (e) {
                console.error("Ошибка удаления данных формы заказа из localStorage:", e);
            }
        }

        function savePrivacyPolicyState() {
            try {
                const isChecked = document.getElementById('privacyPolicyCheckbox').checked;
                localStorage.setItem('privacyPolicyAccepted', JSON.stringify(isChecked));
            } catch (e) {
                console.error("Ошибка сохранения состояния политики конфиденциальности:", e);
            }
        }

        function loadPrivacyPolicyState() {
            try {
                const savedState = localStorage.getItem('privacyPolicyAccepted');
                if (savedState !== null) {
                    document.getElementById('privacyPolicyCheckbox').checked = JSON.parse(savedState);
                }
            } catch (e) {
                console.error("Ошибка загрузки состояния политики конфиденциальности:", e);
            }
        }

        let scrollTimeout;
        const scrollHandler = (e) => {
            if (scrollTimeout) {
                clearTimeout(scrollTimeout);
            }
            scrollTimeout = setTimeout(() => {
                requestAnimationFrame(() => {
                    if (currentView === 'home' && !isLoadingMore && currentPage < totalPages) {
                        const target = e.target === document ? document.documentElement : e.target;
                        const { scrollTop, scrollHeight, clientHeight } = target;
                        const nearBottom = (scrollTop + clientHeight >= scrollHeight - 600);
                        
                        if (nearBottom) {
                             if (currentPage < totalPages) { 
                                loadMoreProducts();
                            }
                        }
                    }
                });
            }, 50); 
        };

        window.addEventListener('scroll', scrollHandler);
        document.getElementById('main-scroll-area').addEventListener('scroll', scrollHandler);


        window.addEventListener('popstate', (event) => {
            if (event.state) {
                navigateTo(event.state.view, event.state.data, true);
            } else {
                handleRouting();
            }
        });

        function handleRouting() {
            const path = window.location.pathname;
            const productSlugMatch = path.match(/^\/product\/(.+)/);

            if (path === '/' || path === '/index.html') {
                navigateTo('home');
            } else if (path === '/profile') {
                navigateTo('profile');
            } else if (path === '/about') {
                navigateTo('aboutStore');
            } else if (productSlugMatch) {
                const slug = productSlugMatch[1];
                navigateToProductDetail(null, slug);
            } else {
                navigateTo('notFound');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadCartFromLocalStorage(); // Загружаем корзину при старте
            
            // Handle SPA routing for GitHub Pages
            if (sessionStorage.redirect) {
                const redirectPath = sessionStorage.redirect;
                sessionStorage.removeItem('redirect');
                
                // Handle product detail routes
                const productSlugMatch = redirectPath.match(/^\/product\/(.+)/);
                if (productSlugMatch) {
                    const slug = productSlugMatch[1];
                    navigateToProductDetail(null, slug);
                    return;
                }
                
                // Handle other routes
                if (redirectPath === '/profile') {
                    navigateTo('profile');
                    return;
                } else if (redirectPath === '/about') {
                    navigateTo('aboutStore');
                    return;
                }
            }
            
            handleRouting();
            updateCartBadge(); // Обновляем бейдж после загрузки корзины
            registerServiceWorker();
            initializePWAInstall();
            initializePrivacyPolicyModal();

            // Слушатели для полей формы заказа будут добавляться динамически при отображении корзины
        });

        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/shop21/sw.js')
                    .then(registration => {
                        console.log('Service Worker зарегистрирован:', registration);
                    })
                    .catch(error => {
                        console.error('Ошибка регистрации Service Worker:', error);
                    });
            }
        }

        function isStandalone() {
            return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
        }

        function openExternalSite() {
            const targetUrl = 'https://store.ikeber.ru';
            const isAndroid = /android/i.test(navigator.userAgent);

            if (isAndroid) {
                // Intent для открытия в Chrome на Android
                const intentUrl = `intent://${targetUrl.replace(/^https?:\/\//, '')}#Intent;package=com.android.chrome;scheme=https;S.browser_fallback_url=${encodeURIComponent(targetUrl)};end;`;
                window.location.href = intentUrl;
            } else {
                // Для iOS и других систем открываем в текущем браузере
                window.location.href = targetUrl;
            }
        }

        function initializePWAInstall() {
            if (isStandalone()) {
                if (headerInstallButton) {
                    headerInstallButton.classList.add('hidden');
                    headerInstallButton.dataset.shouldShow = 'false';
                    updateHeaderUI();
                }
                return;
            }

            // Показываем кнопку всегда, если не в standalone
            if (headerInstallButton) {
                headerInstallButton.classList.remove('hidden');
                headerInstallButton.dataset.shouldShow = 'true';
                updateHeaderUI();
                
                // Удаляем старые обработчики и добавляем новый
                const newButton = headerInstallButton.cloneNode(true);
                headerInstallButton.parentNode.replaceChild(newButton, headerInstallButton);
                document.getElementById('headerInstallButton').addEventListener('click', openExternalSite);
            }
        }

        // --- Privacy Policy Modal Logic ---
        function initializePrivacyPolicyModal() {
            const modal = document.getElementById('privacyPolicyModal');
            const closeBtn = document.getElementById('closePrivacyModal');
            const modalBody = modal.querySelector('.modal-body');

            const openModal = () => {
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.remove('opacity-0', 'visibility-hidden');
                    modal.querySelector('.modal-content').classList.remove('scale-95');
                }, 10);
            };

            const closeModal = () => {
                modal.classList.add('opacity-0');
                modal.querySelector('.modal-content').classList.add('scale-95');
                setTimeout(() => {
                    modal.classList.add('hidden', 'visibility-hidden');
                }, 300);
            };

            closeBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });

            // Fetch and inject the policy content
            fetch('/shop21/privacy-policy.html')
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const policyContent = doc.querySelector('.container');
                    if (policyContent) {
                        modalBody.innerHTML = policyContent.innerHTML;
                    } else {
                        modalBody.innerHTML = '<p>Не удалось загрузить политику конфиденциальности.</p>';
                    }
                })
                .catch(error => {
                    console.error('Ошибка при загрузке политики конфиденциальности:', error);
                    modalBody.innerHTML = '<p>Ошибка при загрузке. Пожалуйста, попробуйте позже.</p>';
                });
            
            // Make the open function global
            window.openPrivacyPolicyModal = openModal;
        }

        function saveCustomerOrdersToLocalStorage(orders) {
            try {
                localStorage.setItem('customerOrders', JSON.stringify(orders));
            } catch (e) {
                console.error("Ошибка сохранения заказов клиента в localStorage:", e);
            }
        }

        function loadCustomerOrdersFromLocalStorage() {
            try {
                const savedOrders = localStorage.getItem('customerOrders');
                return savedOrders ? JSON.parse(savedOrders) : [];
            } catch (e) {
                console.error("Ошибка загрузки заказов клиента из localStorage:", e);
                return [];
            }
        }

    </script>

    </body>
</html>

